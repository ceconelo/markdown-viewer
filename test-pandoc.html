<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Pandoc WASM</title>
</head>
<body>
    <h1>Test Pandoc WebAssembly</h1>
    <button id="test-btn">Test Markdown to DOCX</button>
    <div id="output"></div>
    
    <script type="module">
        // Load pandoc-wasm as ES module
        import { Pandoc } from 'https://cdn.jsdelivr.net/npm/pandoc-wasm@0.0.2/dist/pandoc.mjs';
        window.Pandoc = Pandoc;
        console.log('pandoc-wasm loaded successfully');
        
        document.getElementById('test-btn').addEventListener('click', async () => {
            const output = document.getElementById('output');
            output.innerHTML = 'Testing...';
            
            try {
                console.log('üîÑ Initializing Pandoc WebAssembly...');
                
                // Initialize Pandoc
                const pandoc = new Pandoc();
                await pandoc.init();
                
                console.log('‚úÖ Pandoc WebAssembly initialized successfully');
                console.log('üîÑ Converting markdown to DOCX...');
                
                const testMarkdown = `# Test Document

This is a **test** markdown document for DOCX export.

## Features

- Bold text
- *Italic text*
- Lists

### Code

\`\`\`javascript
console.log("Hello World");
\`\`\`

This should convert to DOCX format.`;
                
                // Convert markdown to DOCX using Pandoc
                const result = await pandoc.run({
                    text: testMarkdown,
                    options: {
                        from: 'markdown',
                        to: 'docx',
                        standalone: true,
                        metadata: {
                            title: 'Test Document',
                            author: 'Test Author'
                        }
                    }
                });

                console.log('‚úÖ Pandoc conversion completed');
                console.log('üìä Result type:', typeof result);
                console.log('üìä Result size:', result?.length || result?.size || 'unknown');
                console.log('Result:', result);
                
                if (result) {
                    // Create download link
                    let blob;
                    if (result instanceof Uint8Array) {
                        blob = new Blob([result], { type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });
                    } else if (result instanceof ArrayBuffer) {
                        blob = new Blob([result], { type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });
                    } else if (typeof result === 'string') {
                        // If result is base64 string, decode it
                        const binaryString = atob(result);
                        const bytes = new Uint8Array(binaryString.length);
                        for (let i = 0; i < binaryString.length; i++) {
                            bytes[i] = binaryString.charCodeAt(i);
                        }
                        blob = new Blob([bytes], { type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });
                    }
                    
                    if (blob) {
                        const url = URL.createObjectURL(blob);
                        output.innerHTML = `
                            <p>‚úÖ DOCX conversion successful!</p>
                            <p>File size: ${blob.size} bytes</p>
                            <a href="${url}" download="test.docx">Download test.docx</a>
                        `;
                    } else {
                        output.innerHTML = '‚ùå Could not create download blob';
                    }
                } else {
                    output.innerHTML = '‚ùå No result from conversion';
                }
                
            } catch (error) {
                console.error('‚ùå Error testing DOCX export:', error);
                output.innerHTML = `‚ùå Error: ${error.message}`;
            }
        });
    </script>
</body>
</html>