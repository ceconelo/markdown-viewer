<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="styles.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Markdown Viewer</title>
    <script src="https://unpkg.com/mermaid@10.6.1/dist/mermaid.min.js" 
            integrity="sha384-+NGfjU8KzpDLXRHduEqW+ZiJr2rIg+cidUVk7B51R5xK7cHwMKQfrdFwGdrq1Bcz" 
            crossorigin="anonymous"></script>
    <script src="https://unpkg.com/dompurify@3.2.6/dist/purify.min.js" 
            integrity="sha384-JEyTNhjM6R1ElGoJns4U2Ln4ofPcqzSsynQkmEc/KGy6336qAZl70tDLufbkla+3" 
            crossorigin="anonymous"></script>
    <script src="https://unpkg.com/docx@7.8.2/build/index.js" 
            integrity="sha384-zjTqOObJTD6OT6CUn8mSpDY+crIiP0cX457OjcZosSATiUFbmdXa9KRScjfLVxFH" 
            crossorigin="anonymous"></script>
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js" crossorigin="anonymous"></script>
    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/styles/github.min.css" 
          id="highlight-theme-light" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/styles/github-dark.min.css" 
          id="highlight-theme-dark" disabled crossorigin="anonymous">
    <script src="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/highlight.min.js" 
            integrity="sha384-F/bZzf7p3Joyp5psL90p/p89AZJsndkSoGwRpXcZhleCWhd8SnRuoYo4d0yirjJp" 
            crossorigin="anonymous"></script>
    <script>
      // DOCX generation using the docx.js library
      window.generateDocxFromMarkdown = async function(markdownText, title) {
        console.log('üîÑ Generating DOCX using docx.js library...');
        
        try {
          // Convert markdown to HTML first
          const html = await window.__TAURI__.core.invoke('parse_markdown', { markdownContent: markdownText });
          
          // Parse the HTML to extract content
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          
          // Create paragraphs from the HTML content
          const paragraphs = [];
          
          // Add title
          paragraphs.push(
            new docx.Paragraph({
              text: title,
              heading: docx.HeadingLevel.TITLE,
              spacing: { after: 400 }
            })
          );
          
          // Process HTML elements
          const elements = doc.body.children;
          for (let i = 0; i < elements.length; i++) {
            const element = elements[i];
            
            if (element.tagName === 'P') {
              paragraphs.push(
                new docx.Paragraph({
                  text: element.textContent,
                  spacing: { after: 200 }
                })
              );
            } else if (element.tagName.match(/^H[1-6]$/)) {
              const level = parseInt(element.tagName.substring(1));
              paragraphs.push(
                new docx.Paragraph({
                  text: element.textContent,
                  heading: level <= 3 ? docx.HeadingLevel['HEADING_' + level] : docx.HeadingLevel.HEADING_3,
                  spacing: { before: 300, after: 200 }
                })
              );
            } else if (element.tagName === 'UL' || element.tagName === 'OL') {
              const listItems = element.getElementsByTagName('li');
              for (let j = 0; j < listItems.length; j++) {
                paragraphs.push(
                  new docx.Paragraph({
                    text: listItems[j].textContent,
                    bullet: element.tagName === 'UL' ? { level: 0 } : undefined,
                    numbering: element.tagName === 'OL' ? { reference: "default-numbering", level: 0 } : undefined,
                    spacing: { after: 100 }
                  })
                );
              }
            } else if (element.tagName === 'BLOCKQUOTE') {
              paragraphs.push(
                new docx.Paragraph({
                  text: element.textContent,
                  style: "Quote",
                  indent: { left: 720 },
                  spacing: { after: 200 }
                })
              );
            } else if (element.tagName === 'PRE') {
              paragraphs.push(
                new docx.Paragraph({
                  text: element.textContent,
                  style: "Code",
                  spacing: { after: 200 }
                })
              );
            }
          }
          
          // Create the document
          const document = new docx.Document({
            sections: [{
              properties: {},
              children: paragraphs
            }]
          });
          
          // Generate DOCX file as blob (browser-compatible)
          const blob = await docx.Packer.toBlob(document);
          console.log('‚úÖ DOCX blob generated successfully, size:', blob.size);
          
          // Convert blob to Uint8Array for Tauri
          const arrayBuffer = await blob.arrayBuffer();
          return new Uint8Array(arrayBuffer);
          
        } catch (error) {
          console.error('‚ùå Failed to generate DOCX:', error);
          throw error;
        }
      };
      
      // Mark as ready
      window.docxReady = true;
      console.log('‚úÖ DOCX generator loaded (docx.js)');
    </script>
    <script>
      // Initialize highlight.js for syntax highlighting
      document.addEventListener('DOMContentLoaded', function() {
        if (typeof hljs !== 'undefined') {
          // Configure highlight.js
          hljs.configure({
            languages: ['javascript', 'typescript', 'python', 'rust', 'html', 'css', 'sql', 'json', 'bash', 'shell', 'yaml', 'xml', 'markdown', 'c', 'cpp', 'java', 'go', 'php', 'ruby', 'swift', 'kotlin']
          });
          
          // Mark as ready
          window.highlightJsReady = true;
          console.log('‚úÖ Highlight.js initialized successfully');
          
          // Function to highlight all code blocks
          window.highlightCodeBlocks = function() {
            if (typeof hljs !== 'undefined') {
              // Find all code blocks that haven't been highlighted yet
              const codeBlocks = document.querySelectorAll('pre code:not(.hljs)');
              codeBlocks.forEach(block => {
                try {
                  hljs.highlightElement(block);
                } catch (error) {
                  console.warn('Error highlighting code block:', error);
                }
              });
            }
          };
          
          // Function to switch highlight.js theme based on color scheme
          window.updateHighlightTheme = function() {
            const lightTheme = document.getElementById('highlight-theme-light');
            const darkTheme = document.getElementById('highlight-theme-dark');
            const isDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (isDarkMode) {
              lightTheme.disabled = true;
              darkTheme.disabled = false;
            } else {
              lightTheme.disabled = false;
              darkTheme.disabled = true;
            }
          };
          
          // Initial theme setup
          window.updateHighlightTheme();
          
          // Listen for color scheme changes
          if (window.matchMedia) {
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', window.updateHighlightTheme);
          }
        } else {
          console.warn('‚ö†Ô∏è Highlight.js not available');
        }
      });
    </script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script type="module" src="/main.js" defer></script>
  </head>

  <body>
    <div class="app">
      <header class="header">
        <h1>Markdown Viewer</h1>
        <div class="controls">
          <input type="file" id="file-input" accept=".md,.markdown,.mdown,.mkd" style="display: none;" />
          <div class="split-button">
            <button id="open-file-btn" class="btn split-btn-main">Open File</button>
            <button id="recent-files-btn" class="btn split-btn-dropdown" title="Recent Files">
              <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
                <path d="M2 4l4 4 4-4z"/>
              </svg>
            </button>
          </div>
          <button id="sample-btn" class="btn btn-secondary">Try Sample</button>
          <div class="zoom-controls" id="zoom-controls" style="display: none;">
            <button id="zoom-out-btn" class="btn btn-secondary zoom-btn" title="Zoom Out (Ctrl+-)">‚àí</button>
            <span id="zoom-level" class="zoom-level">100%</span>
            <button id="zoom-in-btn" class="btn btn-secondary zoom-btn" title="Zoom In (Ctrl++)">+</button>
            <button id="zoom-reset-btn" class="btn btn-secondary zoom-btn" title="Reset Zoom">‚åÇ</button>
          </div>
          <div class="split-button" id="export-button-group" style="display: none;">
            <button id="export-main-btn" class="btn btn-secondary split-btn-main">Export</button>
            <button id="export-dropdown-btn" class="btn btn-secondary split-btn-dropdown" title="Export Options">
              <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
                <path d="M2 4l4 4 4-4z"/>
              </svg>
            </button>
            <div class="dropdown-menu" id="export-dropdown-menu">
              <button class="dropdown-item" id="export-html-btn">Export as HTML</button>
              <button class="dropdown-item" id="export-docx-btn">Export as DOCX</button>
              <button class="dropdown-item" id="print-pdf-btn">Print to PDF</button>
            </div>
          </div>
        </div>
      </header>
      
      <main class="main">
        <div class="welcome" id="welcome-screen">
          <h2>Welcome to Markdown Viewer</h2>
          <p>Click "Open File" to load a markdown file, drag and drop a file here, or try the sample.</p>
          <div class="welcome-actions">
            <button class="btn btn-large" id="welcome-open-btn">
              üìÅ Open File
            </button>
            <button class="btn btn-secondary btn-large" id="welcome-sample-btn">
              üìÑ Try Sample
            </button>
          </div>
        </div>
        
        <div class="viewer" id="markdown-viewer" style="display: none;">
          <div class="content" id="markdown-content"></div>
        </div>
      </main>
    </div>
  </body>
</html>
